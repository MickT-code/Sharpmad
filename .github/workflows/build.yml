name: Build SharpMad

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    timeout-minutes: 60

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Try enable .NET Framework 3.5 (NetFx3) via DISM
      shell: powershell
      run: |
        Write-Host "Attempting to enable NetFx3..."
        dism /online /enable-feature /featurename:NetFx3 /All /Quiet /NoRestart
        Start-Sleep -Seconds 5
        if (Test-Path 'HKLM:\SOFTWARE\Microsoft\NET Framework Setup\NDP\v3.5') {
          Write-Host ".NET Framework 3.5 registry key found."
        } else {
          Write-Host "Warning: v3.5 registry key not found; runtime may be enabled but reference assemblies can still be missing."
        }

    - name: Check for .NET 3.5 reference assemblies
      id: checkref
      shell: powershell
      run: |
        $refPath = 'C:\Program Files (x86)\Reference Assemblies\Microsoft\Framework\.NETFramework\v3.5'
        Write-Host "Checking $refPath"
        if (Test-Path $refPath) {
          Write-Host "FOUND reference assemblies."
          Write-Output "present=true" | Out-File -FilePath $GITHUB_OUTPUT -Encoding utf8
        } else {
          Write-Host "MISSING reference assemblies."
          Write-Output "present=false" | Out-File -FilePath $GITHUB_OUTPUT -Encoding utf8
        }

    - name: Install Visual Studio Build Tools (only if refs missing)
      if: steps.checkref.outputs.present == 'false'
      shell: powershell
      env:
        CHOCO_NO_PROGRESS: 'true'
      run: |
        Write-Host "Reference assemblies missing â€” installing Visual Studio 2022 Build Tools with .NET 3.5 Developer Tools (this may take 10+ minutes)..."

        # Download vs_buildtools.exe (official bootstrapper)
        $vsBootstrapUrl = "https://aka.ms/vs/17/release/vs_buildtools.exe"
        $installer = "$env:TEMP\vs_buildtools.exe"
        Write-Host "Downloading $vsBootstrapUrl to $installer"
        Invoke-WebRequest -Uri $vsBootstrapUrl -OutFile $installer -UseBasicParsing

        # Run installer with the workloads & component that include the .NET 3.5 reference assemblies
        # Microsoft.VisualStudio.Workload.ManagedDesktopBuildTools + Microsoft.Net.Component.3.5.DeveloperTools
        $args = '--quiet --wait --norestart --nocache --installPath "%ProgramFiles%\Microsoft Visual Studio\2022\BuildTools" --add Microsoft.VisualStudio.Workload.ManagedDesktopBuildTools --add Microsoft.Net.Component.3.5.DeveloperTools'
        Write-Host "Starting installer..."
        Start-Process -FilePath $installer -ArgumentList $args -Wait -NoNewWindow

        # Clean up
        Remove-Item $installer -Force -ErrorAction SilentlyContinue

        # Verify installation: check reference assemblies path again
        $refPath = 'C:\Program Files (x86)\Reference Assemblies\Microsoft\Framework\.NETFramework\v3.5'
        if (Test-Path $refPath) {
          Write-Host "Reference assemblies for v3.5 are now present."
        } else {
          Write-Host "ERROR: reference assemblies still missing after Build Tools install. Check installer logs above for failures."
          exit 1
        }

    - name: Setup .NET SDK for CLI tasks
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '7.0.x'

    - name: Restore dependencies
      run: dotnet restore Sharpmad.sln

    - name: Build project
      run: dotnet build Sharpmad.sln --configuration Release

    - name: Upload SharpMad.exe
      uses: actions/upload-artifact@v4
      with:
        name: SharpMad
        path: Sharpmad/bin/Release/**/Sharpmad.exe
